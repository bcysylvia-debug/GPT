<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡”ç½—å·¥åŠ - å®Œç¾ä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #e0c097;
            --bg-gradient: radial-gradient(circle at center, #1a002a 0%, #050008 100%);
            --card-back-pattern: repeating-linear-gradient(45deg, #4a2c5a, #4a2c5a 2px, #2a0c3a 2px, #2a0c3a 4px);
        }

        body {
            background: var(--bg-gradient);
            color: var(--primary-color);
            font-family: 'STKaiti', 'Georgia', serif;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 5px; 
            padding-bottom: 160px; /* ç»™åº•éƒ¨ç»“æœæ ç•™å‡ºç©ºé—´ */
            overflow-x: hidden;
        }

        h1 { font-size: 1.1rem; margin: 8px 0; text-shadow: 0 0 8px rgba(224, 192, 151, 0.5); }

        /* å¯¼èˆªä¸æŒ‰é’® */
        .nav-group { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; justify-content: center; }
        .nav-btn {
            background: rgba(90, 56, 117, 0.3); border: 1px solid var(--primary-color);
            color: var(--primary-color); padding: 5px 12px; border-radius: 4px;
            cursor: pointer; font-size: 12px; transition: 0.2s;
        }
        .nav-btn.active { background: var(--primary-color); color: #1a002a; font-weight: bold; }
        
        .action-btn {
            background: linear-gradient(45deg, #5a3875, #8a58a8); border: none;
            color: white; padding: 6px 20px; border-radius: 15px;
            cursor: pointer; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        #status-bar { margin-bottom: 5px; color: #b893cc; font-size: 12px; height: 16px; text-align: center;}

        /* === ç‰Œæ¡Œç½‘æ ¼ === */
        #deck-grid {
            display: grid; 
            grid-template-columns: repeat(10, 1fr); /* 10åˆ—å¸ƒå±€ */
            gap: 3px; width: 96vw; max-width: 500px;
            margin-top: 5px;
        }
        .grid-yesno { grid-template-columns: repeat(7, 1fr) !important; }

        .card-slot {
            aspect-ratio: 2/3.5; position: relative; cursor: pointer;
            perspective: 600px;
        }

        .card-inner {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s;
            border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .card-slot.flipped .card-inner { transform: rotateY(180deg); }
        /* è‡ªç”±æ¨¡å¼é€‰ä¸­åï¼Œç¨å¾®å˜æš—ä¸€ç‚¹ç‚¹è¡¨ç¤ºå·²é€‰ */
        .card-slot.selected-mark { filter: brightness(0.6); }

        .card-back, .card-front {
            width: 100%; height: 100%; position: absolute;
            backface-visibility: hidden; 
        }

        .card-back { background: var(--card-back-pattern); border: 1px solid #3a1c4a; }

        .card-front {
            background: #1a002a; transform: rotateY(180deg);
            border: 1px solid var(--primary-color);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .card-front img { width: 100%; height: 100%; object-fit: cover; }
        /* é€†ä½æ—‹è½¬ï¼šç›´æ¥æ—‹è½¬å›¾ç‰‡ */
        .card-front img.reversed { transform: rotate(180deg); }

        /* === åº•éƒ¨å›ºå®šç»“æœæ  (è‡ªç”±æ¨¡å¼) === */
        #bottom-result-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 140px; background: rgba(10, 0, 15, 0.95);
            border-top: 1px solid #5a3875;
            z-index: 100;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: row; align-items: center;
            overflow-x: auto; padding: 0 10px; gap: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
        }
        
        .result-item {
            flex: 0 0 auto; width: 70px; display: flex; flex-direction: column; align-items: center;
            animation: slideUp 0.3s ease-out;
        }
        .result-img-box {
            width: 70px; height: 110px; border-radius: 4px; border: 1px solid #b893cc;
            overflow: hidden; background: #000; position: relative;
        }
        .result-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .result-name { font-size: 10px; color: #e0c097; margin-top: 3px; text-align: center; white-space: nowrap;}
        
        .empty-tip { width:100%; text-align:center; color: #666; font-size: 12px; }

        /* === åœ£ä¸‰è§’/YesNo ç»“æœå±•ç¤ºåŒº === */
        .result-container { display: flex; justify-content: center; gap: 10px; width: 100%; flex-wrap: wrap; }
        .tri-card { width: 30vw; max-width: 110px; text-align: center; margin-bottom: 10px; animation: fadeIn 0.5s; }
        .tri-label { font-size: 12px; color: #b893cc; margin-bottom: 4px; }
        
        .yn-box {
            background: rgba(30,0,50,0.9); border: 1px solid #5a3875;
            padding: 15px; border-radius: 12px; text-align: center; width: 85%;
            margin-top: 10px; animation: fadeIn 0.5s;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    </style>
</head>
<body>

    <h1>ğŸ”® å¡”ç½—åœ¨çº¿å·¥åŠ</h1>
    
    <div class="nav-group">
        <button class="nav-btn active" id="tab-triangle" onclick="switchTab('triangle')">åœ£ä¸‰è§’</button>
        <button class="nav-btn" id="tab-free" onclick="switchTab('free')">è‡ªç”±æ— ç‰Œé˜µ</button>
        <button class="nav-btn" id="tab-yesno" onclick="switchTab('yesno')">Yes / No</button>
    </div>

    <div id="ctrl-triangle" class="nav-group">
        <button onclick="setTriangleMode('random')" id="btn-tri-rnd" class="nav-btn active">éšæœºæŠ½</button>
        <button onclick="setTriangleMode('manual')" id="btn-tri-man" class="nav-btn">æ‰‹åŠ¨é€‰</button>
        <button id="btn-tri-go" class="action-btn" onclick="executeTriangleDraw()">å¼€å§‹</button>
    </div>

    <div id="ctrl-free" class="nav-group" style="display:none;">
        <button onclick="drawRandomFree()" class="action-btn">ğŸ² éšæœºæŠ½ä¸€å¼ </button>
        <button onclick="resetFree()" class="nav-btn">é‡ç½®</button>
    </div>

    <div id="status-bar">å‡†å¤‡å°±ç»ª</div>

    <div id="deck-grid"></div>

    <div class="result-container" id="center-results"></div>

    <div id="bottom-result-bar">
        <div class="empty-tip">é€‰ä¸­çš„ç‰Œä¼šæ’åˆ—åœ¨è¿™é‡Œ...</div>
    </div>

<script>
    // === å›¾æºé‡æ„ï¼šä½¿ç”¨ Github ç¨³å®šæº (ekelen/tarot-api) ===
    // å‘½åè§„åˆ™: m00-m21 (å¤§é˜¿å¡çº³), w01-w14 (æƒæ–), c01-c14 (åœ£æ¯), s01-s14 (å®å‰‘), p01-p14 (æ˜Ÿå¸)
    // å®«å»·ç‰Œ: 11=ä¾ä», 12=éª‘å£«, 13=ç‹å, 14=å›½ç‹
    const baseUrl = "https://wsrv.nl/?url=https://raw.githubusercontent.com/ekelen/tarot-api/master/static/images/";
    const suffix = ".jpg&w=150&output=webp"; // åŠ é€Ÿåç¼€

    let tarotDeck = [];
    
    function generateDeck() {
        const suits = [
            {code:'w', name:'æƒæ–'}, {code:'c', name:'åœ£æ¯'}, 
            {code:'s', name:'å®å‰‘'}, {code:'p', name:'æ˜Ÿå¸'}
        ];
        const ranks = [
            "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å", 
            "ä¾ä»", "éª‘å£«", "ç‹å", "å›½ç‹"
        ];
        const majors = [
            "æ„šè€…","é­”æœ¯å¸ˆ","å¥³æ•™çš‡","çš‡å","çš‡å¸","æ•™çš‡","æ‹äºº","æˆ˜è½¦","åŠ›é‡","éšå£«",
            "å‘½è¿ä¹‹è½®","æ­£ä¹‰","å€’åŠäºº","æ­»ç¥","èŠ‚åˆ¶","æ¶é­”","é«˜å¡”","æ˜Ÿæ˜Ÿ","æœˆäº®","å¤ªé˜³","å®¡åˆ¤","ä¸–ç•Œ"
        ];

        let idCounter = 0;

        // å¤§é˜¿å¡çº³ 0-21
        majors.forEach((name, i) => {
            let num = i.toString().padStart(2, '0');
            tarotDeck.push({
                id: idCounter++, 
                name: name, 
                img: `${baseUrl}m${num}${suffix}`,
                isMajor: true
            });
        });

        // å°é˜¿å¡çº³
        suits.forEach(suit => {
            ranks.forEach((rank, i) => {
                let num = (i + 1).toString().padStart(2, '0'); // 01-14
                tarotDeck.push({
                    id: idCounter++,
                    name: suit.name + rank,
                    img: `${baseUrl}${suit.code}${num}${suffix}`,
                    isMajor: false
                });
            });
        });
    }
    generateDeck(); // åˆå§‹åŒ–ç‰Œåº“

    // Yes/No è§„åˆ™
    const ynRules = {};
    // åˆå§‹åŒ–è§„åˆ™: å¤§é˜¿å¡çº³ + 4 Ace(22,36,50,64) + åœ£æ¯ä¹(44)
    // æ³¨æ„: ç”Ÿæˆåçš„IDï¼šæƒæ–1=22, åœ£æ¯1=36, å®å‰‘1=50, æ˜Ÿå¸1=64, åœ£æ¯9=44
    // 27å¼ ç‰ŒIDåˆ—è¡¨
    const ynIds = [
        ...Array.from({length:22}, (_,i)=>i), // 0-21
        22, 36, 50, 64, 44
    ];
    
    // è®¾ç½®è§„åˆ™æ–‡æœ¬
    const setRule = (ids, type) => ids.forEach(id => ynRules[id] = type);
    setRule([22,36,50,64], 'WAIT');
    setRule([44, 0,1,3,4,7,11,17,19,21], 'YES');
    setRule([8,16,14,9,12,13,15], 'NO');
    // å‰©ä¸‹çš„é»˜è®¤ OPEN

    const ynText = { 'YES': 'æ˜ç¡®çš„æ˜¯', 'NO': 'æ˜ç¡®çš„å¦', 'WAIT': 'ç­‰å¾…æ—¶æœº', 'OPEN': 'ä¾ç›´è§‰è§£ç­”' };

    // === å…¨å±€çŠ¶æ€ ===
    let currentTab = 'triangle';
    let triangleMode = 'random';
    let shuffledIndices = [];
    let freePicks = [];

    // === åˆ‡æ¢é€»è¾‘ ===
    function switchTab(tab) {
        currentTab = tab;
        // æ ·å¼é‡ç½®
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        
        // åŒºåŸŸæ˜¾ç¤ºæ§åˆ¶
        document.getElementById('ctrl-triangle').style.display = 'none';
        document.getElementById('ctrl-free').style.display = 'none';
        document.getElementById('deck-grid').innerHTML = '';
        document.getElementById('center-results').innerHTML = '';
        document.getElementById('bottom-result-bar').style.display = 'none';
        document.body.style.paddingBottom = "20px"; // é»˜è®¤padding

        if(tab === 'triangle') {
            document.getElementById('ctrl-triangle').style.display = 'flex';
            setTriangleMode('random');
        } else if(tab === 'free') {
            document.getElementById('ctrl-free').style.display = 'flex';
            document.body.style.paddingBottom = "160px"; // ç»™åº•éƒ¨æ ç•™ç©º
            initFree();
        } else if(tab === 'yesno') {
            initYesNo();
        }
    }

    // === è‡ªç”±æ¨¡å¼ (Free Mode) ===
    function initFree() {
        document.getElementById('status-bar').innerText = 'ç‚¹å‡»ç‰ŒèƒŒæˆ–æŒ‰é’®ï¼Œç»“æœå°†åˆ—åœ¨åº•éƒ¨';
        const grid = document.getElementById('deck-grid');
        grid.className = '';
        const bar = document.getElementById('bottom-result-bar');
        bar.style.display = 'flex';
        bar.innerHTML = '<div class="empty-tip">é€‰ä¸­çš„ç‰Œä¼šæ’åˆ—åœ¨è¿™é‡Œ...</div>';
        freePicks = [];

        shuffledIndices = shuffle(Array.from({length: 78}, (_, i) => i));

        for(let i=0; i<78; i++) {
            const slot = document.createElement('div');
            slot.className = 'card-slot';
            slot.innerHTML = `
                <div class="card-inner">
                    <div class="card-back"></div>
                    <div class="card-front"></div>
                </div>
            `;
            // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»ç‰ŒèƒŒ -> ç¿»å¼€å¹¶æ·»åŠ åˆ°ä¸‹æ–¹
            slot.onclick = () => activateFreeCard(i, slot);
            grid.appendChild(slot);
        }
    }

    function activateFreeCard(idx, slot) {
        if(slot.classList.contains('flipped')) return; // å·²ç¿»å¼€çš„ä¸é‡å¤å¤„ç†

        const realId = shuffledIndices[idx];
        const card = tarotDeck[realId];
        const isRev = Math.random() > 0.5;

        // 1. åŸåœ°ç¿»ç‰Œ (å°å›¾ï¼Œä¿æŒ grid å¸ƒå±€)
        slot.classList.add('flipped');
        slot.classList.add('selected-mark'); // æ ‡è®°å·²é€‰
        const front = slot.querySelector('.card-front');
        front.innerHTML = `<img src="${card.img}" class="${isRev ? 'reversed' : ''}">`;

        // 2. æ·»åŠ åˆ°åº•éƒ¨æ 
        addToBottomBar(card, isRev);
    }

    function drawRandomFree() {
        // åœ¨æ²¡ç¿»å¼€çš„ç‰Œé‡Œéšæœºé€‰ä¸€å¼ 
        const hiddenSlots = Array.from(document.querySelectorAll('.card-slot:not(.flipped)'));
        if(hiddenSlots.length === 0) { alert('ç‰Œå·²æŠ½å®Œ'); return; }
        
        const randomSlot = hiddenSlots[Math.floor(Math.random() * hiddenSlots.length)];
        randomSlot.click(); // è§¦å‘ç‚¹å‡»é€»è¾‘
        
        // æ»šåŠ¨åˆ°åº•éƒ¨æŸ¥çœ‹
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    function addToBottomBar(card, isRev) {
        const bar = document.getElementById('bottom-result-bar');
        if(freePicks.length === 0) bar.innerHTML = ''; // æ¸…ç©ºæç¤º
        freePicks.push(card);

        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
            <div class="result-img-box">
                <img src="${card.img}" class="${isRev ? 'reversed' : ''}">
            </div>
            <div class="result-name">${card.name}${isRev?'(é€†)':''}</div>
        `;
        bar.appendChild(div);
        bar.scrollLeft = bar.scrollWidth; // è‡ªåŠ¨æ»šåˆ°æœ€å³
    }
    
    function resetFree() {
        if(confirm('é‡æ–°å¼€å§‹ï¼Ÿ')) initFree();
    }

    // === Yes/No æ¨¡å¼ ===
    function initYesNo() {
        document.getElementById('status-bar').innerText = 'Yes/No æŠ‰æ‹© (27å¼ é™å®š)';
        const grid = document.getElementById('deck-grid');
        grid.className = 'grid-yesno';
        shuffledIndices = shuffle([...ynIds]);

        for(let i=0; i<27; i++) {
            const slot = document.createElement('div');
            slot.className = 'card-slot';
            slot.innerHTML = '<div class="card-inner"><div class="card-back"></div></div>';
            slot.onclick = () => showYesNoResult(shuffledIndices[i]);
            grid.appendChild(slot);
        }
    }

    function showYesNoResult(id) {
        document.getElementById('deck-grid').innerHTML = ''; // æ¸…ç©º
        const card = tarotDeck[id];
        const type = ynRules[id] || 'OPEN';
        const color = {'YES':'#4caf50','NO':'#f44336','WAIT':'#ff9800','OPEN':'#9c27b0'}[type];

        document.getElementById('center-results').innerHTML = `
            <div class="tri-card" style="width:120px">
                <div class="result-img-box" style="width:120px; height:200px; border-color:${color}">
                    <img src="${card.img}">
                </div>
                <div class="tri-label" style="margin-top:8px; font-size:14px;">${card.name}</div>
            </div>
            <div class="yn-box" style="border-color:${color}">
                <h2 style="color:${color}; margin:0;">${type}</h2>
                <p style="color:#ddd; margin:10px 0;">${ynText[type]}</p>
                <button class="nav-btn" onclick="initYesNo()" style="margin-top:10px;">å†æŠ½ä¸€æ¬¡</button>
            </div>
        `;
    }

    // === åœ£ä¸‰è§’æ¨¡å¼ ===
    let triManualPicks = [];
    function setTriangleMode(mode) {
        triangleMode = mode;
        const grid = document.getElementById('deck-grid');
        document.getElementById('btn-tri-rnd').classList.toggle('active', mode==='random');
        document.getElementById('btn-tri-man').classList.toggle('active', mode==='manual');
        document.getElementById('center-results').innerHTML = '';
        
        if(mode === 'random') {
            grid.innerHTML = '';
            document.getElementById('btn-tri-go').style.display = 'inline-block';
            document.getElementById('status-bar').innerText = 'ç‚¹å‡»å¼€å§‹ç›´æ¥æŠ½å–';
        } else {
            document.getElementById('btn-tri-go').style.display = 'none';
            document.getElementById('status-bar').innerText = 'è¯·æ‰‹åŠ¨é€‰ 3 å¼ ';
            grid.className = '';
            shuffledIndices = shuffle(Array.from({length: 78}, (_, i) => i));
            triManualPicks = [];
            
            for(let i=0; i<78; i++) {
                const slot = document.createElement('div');
                slot.className = 'card-slot';
                slot.innerHTML = '<div class="card-inner"><div class="card-back"></div></div>';
                slot.onclick = () => {
                    if(triManualPicks.length < 3 && !slot.style.opacity) {
                        slot.style.opacity = '0.2'; // è§†è§‰ä¸Šå˜æš—
                        triManualPicks.push(shuffledIndices[i]);
                        document.getElementById('status-bar').innerText = `å·²é€‰ ${triManualPicks.length} / 3`;
                        if(triManualPicks.length === 3) {
                            grid.innerHTML = '';
                            renderTriangle(triManualPicks);
                        }
                    }
                };
                grid.appendChild(slot);
            }
        }
    }

    function executeTriangleDraw() {
        const ids = shuffle(Array.from({length: 78}, (_, i) => i)).slice(0,3);
        renderTriangle(ids);
    }

    function renderTriangle(ids) {
        const labels = ['è¿‡å»', 'ç°åœ¨', 'æœªæ¥'];
        const html = ids.map((id, i) => {
            const card = tarotDeck[id];
            const isRev = Math.random() > 0.5;
            return `
                <div class="tri-card">
                    <div class="tri-label">${labels[i]}</div>
                    <div class="result-img-box" style="width:100%; aspect-ratio:2/3.5; height:auto;">
                        <img src="${card.img}" class="${isRev?'reversed':''}">
                    </div>
                    <div class="tri-label" style="margin-top:5px;">${card.name}${isRev?'(é€†)':''}</div>
                </div>
            `;
        }).join('');
        document.getElementById('center-results').innerHTML = html;
        document.getElementById('status-bar').innerText = 'è§£è¯»å®Œæˆ';
    }

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    window.onload = () => switchTab('triangle');

</script>
</body>
</html>
